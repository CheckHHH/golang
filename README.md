# yandexCalculator

Запуск оркестратора и агента (агентов) надо сначала перейти на страницу https://github.com/CheckHHH/golang

Нужно, что бы у вас был установлен docker. Можно поставить его по инструкциям

https://docs.docker.com/engine/install/

Надо сделать клон репозитория https://github.com/CheckHHH/golang

Если установлен git

git clone https://github.com/CheckHHH/golang

и раcпаковываем в любую папку. Далее переходим в коревую папку и запускаем команду. (ВНИМАНИЕ - порты 8080, 7777 и 5433 должны быть не заняты! Если они заняты и нужны, то надо зайти в папку Orchestrator/config и в файле .env изменить на нужные а так же в файле docker-compose.yaml. Если меняется ORCHESTRATOR_TCP_PORT, то соответствующую настройку необходимо сделать в агенте (из корневой папки папка Agent/config и отредактировать параметр PORT))

docker compose up
или

docker-compose up
После запуска контейнеров можно перейти по адресу

http://localhost:8080/

go run cmd/orchestrator/main.go
Возвращаемся в корневую папку. Затем перейти в папку Agent и из этой папки запустить агент командой

go run cmd/orchestrator/main.go
Запуск базы данных будет возложен на вас. Для корректной работы базы надо запустить (или выполнить запрос) в запущенной PostgreSQL файл yandex.sql из папки sql коревого каталога проекта. База данных должна называться orchestrator. Или вы можете поменять имя в настройках Orchestrator на любое другое.

#Настройки оркестратора

Все настройки находятся в файле ./Orchestrator/config/.env и для докер образа в файле docker-compose.yaml. ORCHESTRATOR_HTTP_PORT - настройка HTTP порта для работы сервера по протоколу http. ORCHESTRATOR_TCP_PORT - настройка для работы TCP сервера. TCP сервер нужен для работы с агентом. ORCHESTRATOR_DB - адрес базы данных. ORCHESTRATOR_DB_NAME - название базы данных. ORCHESTRATOR_DB_PORT - порт для подключения к базе данных. ORCHESTRATOR_DB_USER - имя пользователя для базы данных. ORCHESTRATOR_DB__PASSWORD - пароль для базы данных.

#Настройки агента

Все настройки находятся в файле ./Agent/config/.env и для докер образа в файле docker-compose.yaml. HOST - имя или IP адрес для оркестратора. PORT - порт оркестратора. MAX_GOROUTINES_AGENT - количество горутин у агента.

#Описание API оркестратора

Можно использовать curl, Postman или что-нибудь еще для отправки данных да оркестратор. Так же используется визуальное отображение через веб-браузер. Используются следующие API:

"/" - любой запрос вернет html файл сгенерированных для подключения к оркестратору.

"/duration" - метол POST устанавливает нужное время для каждой арифметической операции. Метод GET вернет текущие настройки времени. Если настроек нет - вернет значения по умолчанию.

"/expression" - метод POST принимает нужное выражение. Поддерживаются операции "+", "-", "*", "/", а так же скобки "(" и ")". Все пробелы игнорируются (удаляются). На данный момент не поддерживаются унарные операции (но в процессе вычисления могут быть данные ниже 0) - можно использовать 0-10 (например), возведение в степень и т.д. Если значение некорректное - система вернет статус 400 и описание ошибки. Если все верное - начнется высчитываться выражение и вернет выражение с его ID, датой его создания, датой завершения и его текущий статус. Если написать выражение, которое уже было, то вернется это выражение, его ID и статус

"/id/{id}" - принимает ID выражения и возвращает его, если оно найдено. Если нет - возвращается статс 400 и ошибка.

"/workers" - по методу GET возвращает количество запущенных агентов, общее количество горутин всех агентов, занятых горутин (ворекров), которые обрабатывают текущую операцию и массив обрабатываемых на данный момент операций.

#Принцип работы программы

Подсчет выражения. Пользователь вводит выражение. Оркестратор принимает выражение,валидирует его и, если валидация проходит, создает AST дерево, разбивая выражение на операции. Затем выражение сохраняется в мапе (если есть соединения с базой данных - выражение сохраняется в базу) и запускается вычисление выражения. Каждая отдельная операция ставится в очередь по порядку добавления и ждет, когда агент попросит данных. Когда воркер агента подключается к оркестратору (каждый воркер подключается в своей горутине), запрашивая данные, данные извлекаются из очереди по порядку, записываются в мапу очереди и отправляются агенту для вычисления. Воркеры агента не сохраняют соединение с орекстатором. После вычисления, агнет возвращает результат операции или ошибку, если операцию не удалось посчитать. Оркестратор принимает операцию, сообщает выражению результат вычисления и сохраняет в мапу вычисленных операций ее состояние. Так же в отдельную мапу сохраняется выражение с подсчитанной операцией для сохранения в базу данных (сохраняется каждую секунду). Дальше все повторяется до тех пор, пока выражение не будет посчитано полностью. Полностью подсчитанное выражение остается в мапе сохраненных выражений.

Установка времени подсчета выражений. Пользователь присылает данных - оркестратор проверяет эти данные и если они верные - перезаписывает и пытается сохранить в базу данных.

Мониторинг агентов. Каждый агент соединяется с оркестратором и держит постоянною связь, периодически сообщая о том, сколько воркеров на данный момент работает и сколько всего есть. Ворекры так же соединяются с оркестратором для запроса операций, но связь не сохраняют. Когда агент отключается - вся информация о работающих на нем процессах и их количество обнуляется.
